# -*- mode: conf -*-
# {{ ansible_managed }}

check host {{ rails_monit_name }} with address {{ rails_domain_name }}
  # http
  if failed
    port 80
    protocol http
    status = 301
    with timeout 1 seconds
  for 2 times within 3 cycles then alert

  # https
  if failed
    port 443
    protocol https
    request "{{ rails_healthcheck_path }}"

    {% if rails_http_auth_enabled -%}
      username {{ rails_http_auth_user }}
      password {{ rails_http_auth_password }}
    {% endif -%}
    with timeout 1 seconds

    {% if rails_monitored_content %}
      content = "{{ rails_monitored_content }}"
    {% endif %}

    with certificate valid > 25 days
    {% if not rails_monit_validate_ssl_cert %}
      with ssl options {selfsigned: allow}
    {% endif %}

  for 2 times within 3 cycles then alert
